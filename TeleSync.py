import os
import asyncio
import discord
from discord.utils import get
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    CommandHandler,
)
from flask import Flask, request, abort

# â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DISCORD_TOKEN     = os.environ['DISCORD_TOKEN']
DISCORD_GUILD_ID  = int(os.environ['DISCORD_GUILD_ID'])
TELEGRAM_TOKEN    = os.environ['TELEGRAM_BOT_TOKEN']
WEBHOOK_URL       = os.environ['WEBHOOK_URL'].rstrip('/') + '/webhook'

CATEGORIES_TO_INCLUDE = [
    'ğŸ“¦ ETHNICITY VAULTS',
    'ğŸ§” MALE CREATORS  / AGENCY',
    'ğŸ’ª HGF',
    'ğŸ¥ NET VIDEO GIRLS',
    'ğŸ‡¨ğŸ‡³ ASIAN .1',
    'ğŸ‡¨ğŸ‡³ ASIAN .2',
    'ğŸ‡²ğŸ‡½ LATINA .1',
    'ğŸ‡²ğŸ‡½ LATINA .2',
    'â„ SNOWBUNNIE .1',
    'â„ SNOWBUNNIE .2',
    'ğŸ‡®ğŸ‡³ INDIAN / DESI',
    'ğŸ‡¸ğŸ‡¦ ARAB',
    'ğŸ§¬ MIXED / LIGHTSKIN',
    'ğŸ´ BLACK',
    'ğŸŒº POLYNESIAN',
    'â˜  GOTH / ALT',
    'ğŸ¦ VAULT BANKS',
    'ğŸ” PORN',
    'Uncatagorised Girls'
]
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€ Discord client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
intents = discord.Intents.default()
intents.guilds   = True
intents.messages = True
discord_client = discord.Client(intents=intents)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€ Telegram application â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tg_app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


async def start_handler(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    # 1) immediate confirmation
    await update.message.reply_text(
        "ğŸ‘‹ Getting up to date list please wait 2â€“5 minsâ€¦"
    )

    # 2) longer-running notice
    await update.message.reply_text(
        "â³ Fetching Model channels please wait, this could take 2â€“5 mins as we have hundredsâ€¦"
    )

    # 3) actually fetch and reply
    try:
        guild = discord_client.get_guild(DISCORD_GUILD_ID)
        if not guild:
            await update.message.reply_text("âŒ Guild not found.")
            return

        lines = []
        for cat_name in CATEGORIES_TO_INCLUDE:
            # find that category object
            cat = get(guild.categories, name=cat_name)
            if not cat:
                continue
            lines.append(f"*{cat_name}*")
            for ch in cat.text_channels:
                lines.append(f"â€¢ {ch.name}")
            lines.append("")  # blank line between categories

        if not lines:
            await update.message.reply_text("âš ï¸ No matching categories found.")
        else:
            text = "\n".join(lines).strip()
            # Use Markdown so the *bold* category names render nicely
            await update.message.reply_markdown(text)
    except Exception as e:
        await update.message.reply_text(f"âŒ Could not fetch channels: {e}")


tg_app.add_handler(CommandHandler("start", start_handler))
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


# â”€â”€ Flask webhook receiver â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app = Flask(__name__)

@app.route('/webhook', methods=['POST'])
def telegram_webhook():
    if request.method == 'POST':
        data = request.get_json(force=True)
        update = Update.de_json(data, tg_app.bot)
        # queue it for the telegram dispatcher
        tg_app.update_queue.put_nowait(update)
        return 'OK'
    abort(400)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


async def set_telegram_webhook():
    # await the coroutine so you don't get "never awaited" warnings
    await tg_app.bot.set_webhook(WEBHOOK_URL)


async def run_bots():
    # 1) register webhook
    await set_telegram_webhook()

    # 2) start discord client (this runs forever)
    await discord_client.start(DISCORD_TOKEN)


if __name__ == '__main__':
    # 1) start Flask in a background thread
    from threading import Thread
    Thread(
        target=lambda: app.run(
            host='0.0.0.0',
            port=int(os.environ.get('PORT', 10000)),
            debug=False
        )
    ).start()

    # 2) run Telegram webhook setup + Discord client
    asyncio.run(run_bots())
